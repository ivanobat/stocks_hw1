---
title: "homework1"
author: "Ivan Aguilar"
date: '2022-05-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:\\Users\\ivano\\Desktop\\DSMMaster\\MLFin\\')
rm(list=ls())

library(tidyverse)
library(xts)
library(quantmod)
library(TTR)
library(lmtest)
library(dygraphs)
```

```{r}
data.env = readRDS('.\\HW1\\WorldMarkts99_20.RDS')

names<-c("India", "Brazil","UK","Germany","USA","China-Shanghai",
             "Spain","Indonesia","Mexico","Japan","Taiwan","VLIC","VIX")

markets_codes = ls(data.env)[1:11]
markets_names = names[1:11]
volatilities_codes = ls(data.env)[12:13]
volatilities_names = names[12:13]

```

```{r}
markets = data.frame(matrix(ncol=2, nrow=11))
colnames(markets) = c('name', 'code')
markets$name = markets_names
markets$code = markets_codes
```

```{r warning=FALSE}
mex_market = xts()
mex_market = na.approx(Ad(get('MXX', data.env)))
mex_market = periodReturn(mex_market,period='daily', type='log')

lambda = 0.94
ratio = 1-lambda
n = 1
mex_ema = EMA(mex_market, n=n, ratio=ratio)

mex_sd = sd(mex_market)
ema_sd = sqrt(mean(mex_ema))

print(mex_sd)
print(ema_sd)
```

```{r}
mex_ema_plot = dygraph(data=mex_ema, main='Exponential Moving Average') %>%
  dyRangeSelector() %>%
  dyAxis('x', label = "Date") %>%
  dyAxis('y', axisLabelFormatter='function(v){return (v).toFixed(4)}') %>%
  dyOptions(axisLabelFontSize=10, fillGraph = FALSE, fillAlpha=0.1, drawPoints=FALSE)
  
mex_ema_plot
```

```{r, warning=FALSE}
return_week = list()
return_month = list()
volat_week = list()
volat_month = list()
periods = c('weekly','monthly')

start_date="2017-07-01"
end_date="2019-06-30"

for (period in periods) {
  for (row in 1:nrow(markets)) {
    temp = xts()
    temp = na.approx(Ad(get(markets[row,'code'], data.env)))
    temp = periodReturn(temp, period=period, type='log')
    temp = window(temp, start=start_date, end=end_date)
    ema = EMA(temp, n=n, ratio=ratio)
    
    if (period == 'weekly') {
      return_week[[markets[row,'name']]] = temp
      volat_week[[markets[row,'name']]] = ema
    } else {
      return_month[[markets[row,'name']]] = temp
      volat_month[[markets[row,'name']]] = ema
    }
  }
}
```

```{r, warning=FALSE}
gtest = function(market1, market2, minorder, maxorder){
  test_result = ""
  for (i in minorder:maxorder) {
    caus = grangertest(market1, market2, order=i)
    if (caus$`Pr(>F)`[2]<0.05) {
      test_result = paste0(test_result,"1")
    }
    else{
      test_result = paste0(test_result,"0")
    }
  }
  return(test_result)
}

res_return_week = data.frame(matrix(nrow=11, ncol=11))
colnames(res_return_week) = names(return_week)
rownames(res_return_week) = names(return_week)

res_return_month = data.frame(matrix(nrow=11, ncol=11))
colnames(res_return_month) = names(return_month)
rownames(res_return_month) = names(return_month)

res_volat_week = data.frame(matrix(nrow=11, ncol=11))
colnames(res_volat_week) = names(return_week)
rownames(res_volat_week) = names(return_week)

res_volat_month = data.frame(matrix(nrow=11, ncol=11))
colnames(res_volat_month) = names(return_month)
rownames(res_volat_month) = names(return_month)

for (first_market in names(return_week)){
  for (second_market in names(return_week)){
    if (first_market!=second_market){

      row = nrow(res_return_week)+1

      caus_week = gtest(return_week[[first_market]], return_week[[second_market]],1,4)
      res_return_week[first_market,second_market] = caus_week
      
      caus_month = gtest(return_month[[first_market]], return_month[[second_market]],1,4)
      res_return_month[first_market,second_market] = caus_month
      
      caus_week = gtest(volat_week[[first_market]], volat_week[[second_market]],1,4)
      res_volat_week[first_market,second_market] = caus_week
      
      caus_month = gtest(volat_month[[first_market]], volat_month[[second_market]],1,4)
      res_volat_month[first_market,second_market] = caus_month
      
      }
    }
}
```

```{r}
res_return_week
```

```{r}
res_return_month
```


```{r}
res_volat_week
```


```{r}
res_volat_month
```



